---
import { getCollection, getEntry } from 'astro:content';
import { Image, getImage } from 'astro:assets';
import { LightGallery } from 'astro-lightgallery';
import Button from '../common/Button.astro';
import { galeriKategoriLabels } from '../../data/constants';
import { uiStrings } from '../../data/uiStrings';

const allGaleri = await getCollection('galeri');
const featuredGaleri = allGaleri
  .filter((g) => g.data.type === 'foto' && g.data.image)
  .sort((a, b) => {
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    return b.data.date.getTime() - a.data.date.getTime();
  })
  .slice(0, 10);

const galeriWithUrls = await Promise.all(
  featuredGaleri.map(async (item) => {
    const optimized = await getImage({ src: item.data.image!, width: 1920 });
    return { ...item, lightboxSrc: optimized.src };
  })
);

const sectionData = await getEntry('siteContent', 'section-titles');
const sectionTitles = sectionData?.data?.sectionTitles;

if (!sectionTitles?.galeri) {
  throw new Error('Missing siteContent entry: section-titles.galeri');
}

const categoryLabels = galeriKategoriLabels;

const masonryPatterns = [
  'col-span-2 row-span-2',
  'col-span-1 row-span-1',
  'col-span-1 row-span-2',
  'col-span-1 row-span-1',
  'col-span-1 row-span-1',
  'col-span-1 row-span-1',
  'col-span-2 row-span-1',
  'col-span-2 row-span-1',
  'col-span-1 row-span-1',
  'col-span-1 row-span-1',
];
---

<section class="py-16 lg:py-24 bg-white">
  <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12" data-aos="fade-up">
      <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
        {sectionTitles.galeri.title}{' '}
        <span class="text-primary">{uiStrings.common.photo}</span>
      </h2>
      <p class="text-gray-600 max-w-2xl mx-auto">
        {sectionTitles.galeri.subtitle}
      </p>
    </div>

    <div class="relative">
      <div class="absolute -top-4 -right-4 z-10">
        <span
          class="bg-accent text-white text-sm font-bold px-4 py-2 rounded-full shadow-lg"
        >
          {allGaleri.filter((g) => g.data.type === 'foto').length}+{' '}
          {uiStrings.common.photo}
        </span>
      </div>

      <LightGallery
        options={{ thumbnail: true }}
        addPlugins={['zoom', 'thumbnail']}
        class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 auto-rows-[120px] md:auto-rows-[150px]"
        id="galeri-preview"
      >
        {
          galeriWithUrls.map((item, index) => {
            const pattern = masonryPatterns[index] || 'col-span-1 row-span-1';
            const category =
              categoryLabels[item.data.kategori] || item.data.kategori;

            return (
              <a
                href={item.lightboxSrc}
                data-sub-html={`<h4>${item.data.title}</h4><p>${category}</p>`}
                class={`gallery-item relative overflow-hidden rounded-xl group cursor-pointer ${pattern}`}
                data-aos="zoom-in"
                data-aos-delay={Math.min(index * 50, 300)}
              >
                {item.data.image && (
                  <Image
                    src={item.data.image}
                    alt={item.data.title}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                    width={400}
                    height={300}
                  />
                )}

                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />

                <div class="absolute inset-0 flex flex-col justify-end p-3 md:p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                  <span class="text-xs text-white/80 mb-1">{category}</span>
                  <h4 class="text-white font-semibold text-sm md:text-base line-clamp-2">
                    {item.data.title}
                  </h4>
                </div>
              </a>
            );
          })
        }
      </LightGallery>
    </div>

    <div class="text-center mt-10">
      <Button
        href="/galeri"
        variant="primary"
        size="lg"
        class="gap-3 rounded-2xl shadow-xl hover:shadow-2xl"
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
          >
          </path>
        </svg>
        {uiStrings.home.galeri.viewAll}
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 8l4 4m0 0l-4 4m4-4H3"
          >
          </path>
        </svg>
      </Button>
    </div>
  </div>
</section>

<style>
  .gallery-item::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(
      135deg,
      rgba(14, 165, 233, 0.3) 0%,
      transparent 50%
    );
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1;
  }

  .gallery-item:hover::before {
    opacity: 1;
  }

  .gallery-item > div {
    z-index: 2;
  }
</style>
