---
import { getCollection, getEntry } from 'astro:content';
import { Image } from 'astro:assets';
import SectionTitle from '../common/SectionTitle.astro';
import Button from '../common/Button.astro';
import { uiStrings } from '../../data/uiStrings';

const allWisata = await getCollection('wisata');
const sortedWisata = allWisata.sort((a, b) => a.data.order - b.data.order);

// Duplicate for seamless infinite loop
const duplicatedWisata = Array(3)
  .fill(null)
  .flatMap(() => sortedWisata);

const sectionData = await getEntry('siteContent', 'section-titles');
const sectionTitles = sectionData?.data?.sectionTitles;

if (!sectionTitles?.wisata) {
  throw new Error('Missing siteContent entry: section-titles.wisata');
}
---

<section class="py-16 lg:py-24 bg-secondary">
  <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 mb-8">
    <SectionTitle
      title={sectionTitles.wisata.title}
      subtitle={sectionTitles.wisata.subtitle}
      center={true}
    />
  </div>

  <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-end gap-3 mb-4">
      <button
        class="wisata-prev w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
        aria-label={uiStrings.home.wisata.carouselPrevious}
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"
          >
          </path>
        </svg>
      </button>
      <button
        class="wisata-next w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition-colors"
        aria-label={uiStrings.home.wisata.carouselNext}
      >
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"
          >
          </path>
        </svg>
      </button>
    </div>
    <div class="overflow-hidden -mx-4 px-4">
      <div class="wisata-embla py-4 -my-2" id="wisata-carousel">
        <div class="wisata-embla__container flex">
          {
            duplicatedWisata.map((wisata) => (
              <div class="wisata-embla__slide flex-none w-[300px] md:w-[400px] lg:w-[450px] mr-6">
                <a
                  href={`/potensi/wisata/${wisata.slug}`}
                  class="wisata-card block group"
                >
                  <div class="relative h-[400px] md:h-[500px] rounded-3xl overflow-hidden">
                    <Image
                      src={wisata.data.thumbnail}
                      alt={wisata.data.title}
                      class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                      width={450}
                      height={500}
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent" />

                    <div class="absolute top-4 left-4">
                      <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white/20 backdrop-blur-md text-white text-sm font-medium rounded-full border border-white/30">
                        <span>üèñÔ∏è</span>
                        <span class="uppercase tracking-wide">
                          {wisata.data.kategori}
                        </span>
                      </span>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 p-6">
                      <div class="glass-panel p-4 rounded-2xl">
                        <h3 class="text-xl md:text-2xl font-bold text-white mb-2 group-hover:text-accent transition-colors">
                          {wisata.data.title}
                        </h3>
                        <p class="text-white/80 text-sm line-clamp-2 mb-3">
                          {wisata.data.description}
                        </p>
                        <div class="flex items-center justify-between">
                          <div class="flex items-center gap-3 text-sm text-white/70">
                            <span class="flex items-center gap-1">
                              <span>üé´</span> {wisata.data.tiket}
                            </span>
                            <span class="flex items-center gap-1">
                              <span>üïê</span>{' '}
                              {wisata.data.jamBuka?.split(' ')[0]}
                            </span>
                          </div>
                          <span class="inline-flex items-center gap-1 text-accent font-medium text-sm group-hover:gap-2 transition-all">
                            {uiStrings.home.wisata.explore}
                            <svg
                              class="w-4 h-4"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M17 8l4 4m0 0l-4 4m4-4H3"
                              />
                            </svg>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </a>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-8">
    <Button
      href="/potensi"
      variant="outline"
      class="gap-2 border-0 shadow-none bg-transparent"
    >
      {uiStrings.home.wisata.viewAll}
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M17 8l4 4m0 0l-4 4m4-4H3"
        >
        </path>
      </svg>
    </Button>
  </div>
</section>

<style>
  .glass-panel {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
</style>

<script>
  import EmblaCarousel from 'embla-carousel';
  import Autoplay from 'embla-carousel-autoplay';

  let emblaInstance: ReturnType<typeof EmblaCarousel> | null = null;

  const initWisataCarousel = () => {
    const node = document.getElementById('wisata-carousel');
    if (!node) return;

    if (emblaInstance) {
      emblaInstance.destroy();
    }

    emblaInstance = EmblaCarousel(
      node,
      {
        loop: true,
        align: 'start',
        dragFree: true,
      },
      [
        Autoplay({
          delay: 3000,
          stopOnMouseEnter: true,
          stopOnInteraction: false,
        }),
      ]
    );

    const autoplay = emblaInstance.plugins().autoplay;
    const prevBtn = document.querySelector('.wisata-prev');
    const nextBtn = document.querySelector('.wisata-next');

    prevBtn?.addEventListener('click', () => {
      autoplay.stop();
      emblaInstance?.scrollPrev();
    });
    nextBtn?.addEventListener('click', () => {
      autoplay.stop();
      emblaInstance?.scrollNext();
    });
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWisataCarousel);
  } else {
    initWisataCarousel();
  }

  document.addEventListener('astro:page-load', initWisataCarousel);
</script>
