---
import { getEntry } from 'astro:content';
import Button from '../common/Button.astro';

const contactEntry = await getEntry('siteContent', 'kontak-form');

type ContactFieldType = 'text' | 'textarea' | 'select';

type ContactFieldOption = {
  label: string;
  value: string;
};

type ContactField = {
  id: string;
  label: string;
  name: string;
  type: ContactFieldType;
  placeholder?: string;
  required?: boolean;
  options?: ContactFieldOption[];
  rows?: number;
};

type ContactFormConfig = {
  title: string;
  description?: string;
  note?: string;
  actionUrl: string;
  target?: string;
  submitLabel: string;
  toast?: {
    message: string;
    type?: string;
    duration?: number;
  };
  fields: ContactField[];
};

const formConfig: ContactFormConfig | undefined =
  contactEntry?.data?.contactForm;

type ToastType = 'success' | 'error' | 'info';

type ToastOptions = {
  message: string;
  type?: ToastType;
  duration?: number;
};

const defaultFields: ContactField[] = [
  {
    id: 'nama',
    label: 'Nama Lengkap',
    name: 'entry.2116275708',
    type: 'text',
    placeholder: 'Masukkan nama Anda',
    required: true,
  },
  {
    id: 'kontak',
    label: 'No. WhatsApp / Email',
    name: 'entry.175133211',
    type: 'text',
    placeholder: '08xxxxxxxxxx atau email@example.com',
    required: true,
  },
  {
    id: 'subjek',
    label: 'Subjek',
    name: 'entry.1266128475',
    type: 'select',
    placeholder: 'Pilih subjek',
    options: [
      { label: 'Pertanyaan', value: 'pertanyaan' },
      { label: 'Saran', value: 'saran' },
      { label: 'Kritik', value: 'kritik' },
      { label: 'Kerjasama', value: 'kerjasama' },
      { label: 'Lainnya', value: 'lainnya' },
    ],
    required: true,
  },
  {
    id: 'pesan',
    label: 'Pesan',
    name: 'entry.1942425125',
    type: 'textarea',
    rows: 4,
    placeholder: 'Tulis pesan Anda di sini...',
    required: true,
  },
];

function normalizeToastType(value: unknown): ToastType | undefined {
  if (value === 'success' || value === 'error' || value === 'info')
    return value;
  return undefined;
}

const title = formConfig?.title ?? 'Kirim Pesan';
const description =
  formConfig?.description ??
  'Sampaikan pertanyaan, saran, kritik, atau aspirasi Anda. Pesan akan diteruskan ke perangkat dusun.';
const note =
  formConfig?.note ??
  'Form dikirim langsung ke Google Sheets melalui Google Forms tanpa membuka tab baru.';
const actionUrl =
  formConfig?.actionUrl ??
  'https://docs.google.com/forms/u/0/d/e/1FAIpQLSfWaCgBA-cNraUbTmOGjlmrZQ-99edYMdUSkbA-kQBtZm6QOw/formResponse';
const target = formConfig?.target ?? '_blank';
const fields = formConfig?.fields ?? defaultFields;
const submitLabel = formConfig?.submitLabel ?? 'Kirim Pesan →';
const toastConfig: ToastOptions = {
  message:
    formConfig?.toast?.message ?? 'Pesan Anda sedang dikirim. Terima kasih!',
  type: normalizeToastType(formConfig?.toast?.type) ?? 'success',
  duration: formConfig?.toast?.duration ?? 5000,
};
const toastDataAttr = JSON.stringify(toastConfig);
---

<div data-aos="fade-up">
  <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
    <span class="text-2xl">✉️</span>
    {title}
  </h2>
  <div class="bg-white rounded-2xl p-6 md:p-8 shadow-lg relative">
    <p class="text-gray-600 mb-6">{description}</p>

    <form
      id="contact-form"
      action={actionUrl}
      method="POST"
      target={target}
      data-toast={toastDataAttr}
      class="space-y-5"
    >
      {
        fields.map((field: ContactField) => (
          <div>
            <label
              for={field.id}
              class="block text-sm font-semibold text-gray-700 mb-2"
            >
              {field.label}
              {field.required && <span class="text-red-500"> *</span>}
            </label>

            {field.type === 'textarea' ? (
              <textarea
                id={field.id}
                name={field.name}
                rows={field.rows ?? 4}
                required={field.required}
                placeholder={field.placeholder}
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition resize-none"
              />
            ) : field.type === 'select' ? (
              <select
                id={field.id}
                name={field.name}
                required={field.required}
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition"
              >
                <option value="">
                  {field.placeholder ?? 'Pilih salah satu'}
                </option>
                {field.options?.map((option: ContactFieldOption) => (
                  <option value={option.value}>{option.label}</option>
                ))}
              </select>
            ) : (
              <input
                type="text"
                id={field.id}
                name={field.name}
                required={field.required}
                placeholder={field.placeholder}
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition"
              />
            )}
          </div>
        ))
      }

      <Button type="submit" class="w-full"> {submitLabel} </Button>
    </form>

    {note && <p class="text-xs text-gray-500 mt-4 text-center">{note}</p>}

    <div
      id="contact-loading"
      class="hidden absolute inset-0 rounded-2xl bg-white/80 backdrop-blur-sm flex items-center justify-center text-gray-700"
      aria-live="polite"
    >
      <div class="flex items-center gap-3">
        <div
          class="animate-spin h-5 w-5 rounded-full border-2 border-gray-300 border-t-primary"
        >
        </div>
        <span>Mengirim pesan...</span>
      </div>
    </div>
  </div>
</div>

<script>
  let formHandler: ((event: SubmitEvent) => void) | null = null;
  let formElement: HTMLFormElement | null = null;
  let overlayElement: HTMLElement | null = null;
  let clientToastConfig: ToastOptions | null = null;

  function isRecord(value: unknown): value is Record<string, unknown> {
    return typeof value === 'object' && value !== null;
  }

  function parseToastOptions(raw: string): ToastOptions | null {
    try {
      const parsed: unknown = JSON.parse(raw);
      if (!isRecord(parsed)) return null;

      const message =
        typeof parsed.message === 'string' ? parsed.message : null;
      if (!message) return null;

      const type =
        parsed.type === 'success' ||
        parsed.type === 'error' ||
        parsed.type === 'info'
          ? parsed.type
          : undefined;
      const duration =
        typeof parsed.duration === 'number' ? parsed.duration : undefined;

      return { message, type, duration };
    } catch {
      return null;
    }
  }

  document.addEventListener('astro:page-load', () => {
    const element = document.getElementById('contact-form');
    if (!(element instanceof HTMLFormElement)) return;
    formElement = element;
    overlayElement = document.getElementById('contact-loading');

    const toastData = element.getAttribute('data-toast');
    if (toastData) {
      clientToastConfig = parseToastOptions(toastData);
    }

    const handler = async (event: SubmitEvent) => {
      event.preventDefault();
      const formData = new FormData(element);
      const action = element.getAttribute('action') || '';

      try {
        if (overlayElement) {
          overlayElement.classList.remove('hidden');
        }
        await fetch(action, {
          method: 'POST',
          mode: 'no-cors',
          body: formData,
        });
      } catch (err) {
        console.error('Gagal mengirim formulir kontak', err);
      } finally {
        if (overlayElement) {
          overlayElement.classList.add('hidden');
        }
      }

      element.reset();

      setTimeout(() => {
        if (window.toast && clientToastConfig?.message) {
          window.toast.show({
            message: clientToastConfig.message,
            type: clientToastConfig.type ?? 'success',
            duration: clientToastConfig.duration ?? 5000,
          });
        }
      }, 100);
    };

    formHandler = handler;

    formElement.addEventListener('submit', handler);
  });

  document.addEventListener('astro:before-swap', () => {
    if (formElement && formHandler) {
      formElement.removeEventListener('submit', formHandler);
      formHandler = null;
      formElement = null;
    }
  });
</script>
