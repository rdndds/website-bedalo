---
import { Image, getImage } from 'astro:assets';
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { LightGallery } from 'astro-lightgallery';
import { galeriKategoriList } from '../data/constants';
import { uiStrings } from '../data/uiStrings';

const ITEMS_PER_PAGE = 12;

const allGaleri = await getCollection('galeri');
const sortedGaleri = allGaleri.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

const fotoItems = sortedGaleri.filter((item) => item.data.type === 'foto');
const videoItems = sortedGaleri.filter((item) => item.data.type === 'video');

// Pre-process foto items to get optimized image URLs for lightbox
const fotoWithUrls = await Promise.all(
  fotoItems.map(async (item, index) => {
    if (item.data.image) {
      const optimized = await getImage({ src: item.data.image, width: 1920 });
      return { ...item, lightboxSrc: optimized.src, index };
    }
    return { ...item, lightboxSrc: '', index };
  })
);

function getYouTubeThumbnail(url: string): string {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  const videoId = match && match[2].length === 11 ? match[2] : null;
  return videoId
    ? `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`
    : '';
}
---

<BaseLayout>
  <section class="py-12 lg:py-16">
    <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-8" data-aos="fade-up">
        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4">
          <span class="gradient-text">{uiStrings.pages.galeri.titleHighlight}</span>
          {' '}
          {uiStrings.pages.galeri.titleSuffix}
        </h1>
        <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-4">
          {uiStrings.pages.galeri.description}
        </p>
        <div class="inline-flex items-center gap-4 text-sm text-gray-500">
          <span class="flex items-center gap-1">
            <span class="text-lg">üì∑</span>
            <strong class="text-gray-900">{fotoItems.length}</strong> Foto
          </span>
          <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
          <span class="flex items-center gap-1">
            <span class="text-lg">üé¨</span>
            <strong class="text-gray-900">{videoItems.length}</strong> Video
          </span>
        </div>
      </div>

      <div class="flex justify-center mb-6">
        <div class="inline-flex bg-gray-100 p-1 rounded-xl gap-1">
          <button
            id="tab-foto"
            class="type-tab px-5 py-2.5 rounded-lg font-medium transition-all bg-white text-primary shadow-sm"
            data-type="foto"
          >
            {uiStrings.pages.galeri.tabPhoto}
            <span class="text-xs opacity-70 ml-1">({fotoItems.length})</span>
          </button>
          <button
            id="tab-video"
            class="type-tab px-5 py-2.5 rounded-lg font-medium transition-all text-gray-600 hover:text-gray-900"
            data-type="video"
          >
            {uiStrings.pages.galeri.tabVideo}
            <span class="text-xs opacity-70 ml-1">({videoItems.length})</span>
          </button>
        </div>
      </div>

      <div class="flex justify-center mb-4">
        <div
          class="flex gap-2 overflow-x-auto pb-2 px-4 max-w-full scrollbar-hide"
        >
          {
            galeriKategoriList.map((kat) => (
              <button
                data-filter={kat.id}
                class:list={[
                  'filter-btn shrink-0 inline-flex items-center gap-1.5 px-4 py-2 rounded-full text-sm font-medium transition-all border',
                  kat.id === 'semua'
                    ? 'bg-primary text-white border-primary'
                    : 'bg-white text-gray-600 border-gray-200 hover:border-primary hover:text-primary',
                ]}
              >
                <span>{kat.icon}</span>
                <span>{kat.label}</span>
              </button>
            ))
          }
        </div>
      </div>

      <div id="filter-status" class="text-center text-sm text-gray-500 mb-8">
        {uiStrings.pages.galeri.status.prefix}{' '}
        <strong id="visible-count" class="text-gray-900">{fotoItems.length}</strong>
        {' '}
        {uiStrings.pages.galeri.status.typePhoto}
      </div>

      <div id="foto-section">
        {
          fotoWithUrls.length > 0 ? (
            <>
              <LightGallery
                options={{ thumbnail: true }}
                addPlugins={['zoom', 'thumbnail']}
                class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6"
                id="foto-grid"
              >
                {fotoWithUrls.map((item, idx) => (
                  <a
                    href={item.lightboxSrc}
                    data-sub-html={`<h4>${item.data.title}</h4><p>${item.data.kategori}</p>`}
                    data-kategori={item.data.kategori}
                    data-tags={item.data.tags?.join(',') || ''}
                    data-index={idx}
                    class:list={[
                      'foto-item group relative aspect-square overflow-hidden rounded-2xl bg-gray-200 shadow-lg hover:shadow-xl transition-all cursor-pointer',
                      idx >= ITEMS_PER_PAGE ? 'hidden' : '',
                    ]}
                  >
                    {item.data.image && (
                      <Image
                        src={item.data.image}
                        alt={item.data.title}
                        width={400}
                        height={400}
                        class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                        loading="lazy"
                        decoding="async"
                      />
                    )}
                    {item.data.featured && (
                      <span class="absolute top-3 right-3 px-2 py-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full">
                        ‚≠ê {uiStrings.common.featured}
                      </span>
                    )}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                      <div class="absolute bottom-0 left-0 right-0 p-4 translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                        <p class="text-white font-semibold">
                          {item.data.title}
                        </p>
                        <p class="text-white/70 text-sm capitalize">
                          {item.data.kategori}
                        </p>
                        {item.data.tags && item.data.tags.length > 0 && (
                          <div class="flex flex-wrap gap-1 mt-2">
                            {item.data.tags.slice(0, 3).map((tag) => (
                              <span class="px-2 py-0.5 bg-white/20 rounded-full text-xs text-white">
                                #{tag}
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </a>
                ))}
              </LightGallery>

              {fotoWithUrls.length > ITEMS_PER_PAGE && (
                <div class="text-center mt-8">
                  <button
                    id="load-more-foto"
                    class="inline-flex items-center gap-2 px-8 py-3 bg-primary text-white font-semibold rounded-xl shadow-md hover:bg-primary-hover hover:-translate-y-0.5 hover:shadow-lg transition-all"
                    data-total={fotoWithUrls.length}
                    data-per-page={ITEMS_PER_PAGE}
                  >
                    <span>{uiStrings.common.loadMore}</span>
                    <span id="foto-count" class="text-sm opacity-80">
                      ({ITEMS_PER_PAGE}/{fotoWithUrls.length})
                    </span>
                  </button>
                </div>
              )}
            </>
          ) : (
            <div class="bg-white rounded-2xl p-16 shadow-lg text-center">
              <div class="text-7xl mb-4">üì∑</div>
              <p class="text-gray-500 text-lg">
                {uiStrings.pages.galeri.emptyPhoto}
              </p>
            </div>
          )
        }
      </div>

      <div id="video-section" class="hidden">
        {
          videoItems.length > 0 ? (
            <LightGallery
              options={{}}
              addPlugins={['video']}
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
            >
              {videoItems.map((item, idx) => {
                const thumbUrl = getYouTubeThumbnail(item.data.videoUrl || '');
                return (
                  <a
                    href={item.data.videoUrl}
                    data-sub-html={`<h4>${item.data.title}</h4><p>${item.data.kategori}</p>`}
                    data-kategori={item.data.kategori}
                    data-tags={item.data.tags?.join(',') || ''}
                    data-index={idx}
                    class="video-item group relative aspect-video overflow-hidden rounded-2xl bg-gray-900 shadow-lg hover:shadow-xl transition-all cursor-pointer"
                  >
                    <img
                      src={thumbUrl}
                      alt={item.data.title}
                      class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 flex items-center justify-center">
                      <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                        <svg
                          class="w-7 h-7 text-white ml-1"
                          fill="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path d="M8 5v14l11-7z" />
                        </svg>
                      </div>
                    </div>
                    {item.data.featured && (
                      <span class="absolute top-3 right-3 px-2 py-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full">
                        ‚≠ê {uiStrings.common.featured}
                      </span>
                    )}
                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/80 to-transparent">
                      <p class="text-white font-semibold">{item.data.title}</p>
                      <p class="text-white/70 text-sm capitalize">
                        {item.data.kategori}
                      </p>
                    </div>
                  </a>
                );
              })}
            </LightGallery>
          ) : (
            <div class="bg-white rounded-2xl p-16 shadow-lg text-center">
              <div class="text-7xl mb-4">üé¨</div>
              <p class="text-gray-500 text-lg">
                {uiStrings.pages.galeri.emptyVideo}
              </p>
            </div>
          )
        }
      </div>

      <div
        id="no-results"
        class="hidden bg-white rounded-2xl p-16 shadow-lg text-center"
      >
        <div class="text-7xl mb-4">üîç</div>
        <p class="text-gray-500 text-lg">
          {uiStrings.pages.galeri.noResults}
        </p>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  import { uiStrings } from '../data/uiStrings';

  let cleanupFns: (() => void)[] = [];

  document.addEventListener('astro:page-load', () => {
    const loadMoreFotoBtn = document.getElementById(
      'load-more-foto'
    ) as HTMLElement | null;
    const fotoCountEl = document.getElementById('foto-count');
    const fotoSection = document.getElementById('foto-section');
    const videoSection = document.getElementById('video-section');
    const noResults = document.getElementById('no-results');

    const itemsPerPage = parseInt(loadMoreFotoBtn?.dataset.perPage || '12');
    const totalFoto = parseInt(loadMoreFotoBtn?.dataset.total || '0');
    let fotoLoaded = itemsPerPage;
    let activeCategory = 'semua';

    // Type tabs (segmented control)
    const typeTabs = document.querySelectorAll('.type-tab');
    let activeType = 'foto';

    typeTabs.forEach((tab) => {
      const handler = () => {
        const type = tab.getAttribute('data-type');
        activeType = type || 'foto';

        typeTabs.forEach((t) => {
          t.classList.remove('bg-white', 'text-primary', 'shadow-sm');
          t.classList.add('text-gray-600');
        });
        tab.classList.remove('text-gray-600');
        tab.classList.add('bg-white', 'text-primary', 'shadow-sm');

        if (type === 'foto') {
          fotoSection?.classList.remove('hidden');
          videoSection?.classList.add('hidden');
        } else {
          fotoSection?.classList.add('hidden');
          videoSection?.classList.remove('hidden');
        }

        updateFilterStatus();
      };
      tab.addEventListener('click', handler);
      cleanupFns.push(() => tab.removeEventListener('click', handler));
    });

    // Load More for Foto
    if (loadMoreFotoBtn) {
      const loadMoreHandler = () => {
        const fotoItems = document.querySelectorAll('.foto-item');
        const newLoaded = Math.min(fotoLoaded + itemsPerPage, totalFoto);

        fotoItems.forEach((item, idx) => {
          if (idx < newLoaded) {
            item.classList.remove('hidden');
          }
        });

        fotoLoaded = newLoaded;

        if (fotoCountEl) {
          fotoCountEl.textContent = `(${fotoLoaded}/${totalFoto})`;
        }

        if (fotoLoaded >= totalFoto) {
          loadMoreFotoBtn.style.display = 'none';
        }

        // Refresh AOS for newly visible elements
        if (window.AOS) {
          window.AOS.refresh();
        }

        updateFilterStatus();
      };
      loadMoreFotoBtn.addEventListener('click', loadMoreHandler);
      cleanupFns.push(() =>
        loadMoreFotoBtn.removeEventListener('click', loadMoreHandler)
      );
    }

    // Update filter status text
    function updateFilterStatus() {
      const filterStatus = document.getElementById('filter-status');
      if (!filterStatus) return;

      const items =
        activeType === 'foto'
          ? document.querySelectorAll('.foto-item:not(.hidden)')
          : document.querySelectorAll('.video-item:not(.hidden)');

      const count = items.length;
      const status = uiStrings.pages.galeri.status;
      const typeLabel =
        activeType === 'foto' ? status.typePhoto : status.typeVideo;
      const categoryLabel =
        activeCategory === 'semua'
          ? ''
          : `${status.categoryPrefix}${activeCategory}`;

      filterStatus.innerHTML = `${status.prefix} <strong class="text-gray-900">${count}</strong> ${typeLabel}${categoryLabel}`;
    }

    // Filter function
    function applyFilters() {
      let visibleCount = 0;
      let matchedCount = 0;
      const currentSection = fotoSection?.classList.contains('hidden')
        ? 'video'
        : 'foto';
      const items =
        currentSection === 'foto'
          ? document.querySelectorAll('.foto-item')
          : document.querySelectorAll('.video-item');

      items.forEach((item) => {
        const kategori = item.getAttribute('data-kategori');

        const matchesCategory =
          activeCategory === 'semua' || kategori === activeCategory;

        if (matchesCategory) {
          matchedCount++;
          if (currentSection === 'foto') {
            if (matchedCount <= fotoLoaded) {
              item.classList.remove('hidden');
              visibleCount++;
            } else {
              item.classList.add('hidden');
            }
          } else {
            item.classList.remove('hidden');
            visibleCount++;
          }
        } else {
          item.classList.add('hidden');
        }
      });

      if (currentSection === 'foto' && loadMoreFotoBtn) {
        if (matchedCount <= fotoLoaded || activeCategory !== 'semua') {
          loadMoreFotoBtn.style.display = 'none';
        } else {
          loadMoreFotoBtn.style.display = 'inline-flex';
        }
      }

      if (noResults) {
        if (visibleCount === 0) {
          noResults.classList.remove('hidden');
        } else {
          noResults.classList.add('hidden');
        }
      }

      updateFilterStatus();
    }

    // Category filter
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach((btn) => {
      const handler = () => {
        activeCategory = btn.getAttribute('data-filter') || 'semua';

        fotoLoaded = itemsPerPage;
        if (fotoCountEl) {
          fotoCountEl.textContent = `(${fotoLoaded}/${totalFoto})`;
        }

        filterBtns.forEach((b) => {
          b.classList.remove('bg-primary', 'text-white', 'border-primary');
          b.classList.add('bg-white', 'text-gray-600', 'border-gray-200');
        });
        btn.classList.remove('bg-white', 'text-gray-600', 'border-gray-200');
        btn.classList.add('bg-primary', 'text-white', 'border-primary');

        applyFilters();
      };
      btn.addEventListener('click', handler);
      cleanupFns.push(() => btn.removeEventListener('click', handler));
    });
  });

  document.addEventListener('astro:before-swap', () => {
    cleanupFns.forEach((fn) => fn());
    cleanupFns = [];
  });
</script>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>
